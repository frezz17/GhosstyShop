import random
import logging
from datetime import datetime
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup, InputMediaPhoto
from telegram.ext import ApplicationBuilder, CommandHandler, CallbackQueryHandler, ContextTypes

# ================== CONFIGURATION & CONSTANTS ==================
TOKEN = "8351638507:AAFLXfPTk7QSJbKaIjO_o7-PItP4_qVuWH0"
MANAGER_URL = "https://t.me/ghosstydp"
WELCOME_PHOTO = "https://i.ibb.co/y7Q194N/1770068775663.png"
PROMO_EXPIRY = "25.03.2026"
DISCOUNT_RATE = 0.7  # -30%

# Professional Logging
logging.basicConfig(format='%(asctime)s - %(name)s - %(levelname)s - %(message)s', level=logging.INFO)

# ================== DATA REPOSITORY ==================
LOCATIONS = {
    "ĞšĞ¸Ñ—Ğ² ğŸ™ï¸": ["ĞŸĞµÑ‡ĞµÑ€ÑÑŒĞºĞ¸Ğ¹ ğŸ›ï¸", "ĞĞ±Ğ¾Ğ»Ğ¾Ğ½ÑÑŒĞºĞ¸Ğ¹ ğŸ¡", "Ğ”Ğ°Ñ€Ğ½Ğ¸Ñ†ÑŒĞºĞ¸Ğ¹ ğŸ—ï¸", "Ğ”ĞµÑĞ½ÑĞ½ÑÑŒĞºĞ¸Ğ¹ ğŸŒ³", "Ğ¡Ğ²ÑÑ‚Ğ¾ÑˆĞ¸Ğ½ÑÑŒĞºĞ¸Ğ¹ ğŸ›¤ï¸", "Ğ“Ğ¾Ğ»Ğ¾ÑÑ–Ñ—Ğ²ÑÑŒĞºĞ¸Ğ¹ ğŸŒ²", "Ğ¨ĞµĞ²Ñ‡ĞµĞ½ĞºÑ–Ğ²ÑÑŒĞºĞ¸Ğ¹ ğŸ“", "Ğ¡Ğ¾Ğ»Ğ¾Ğ¼â€™ÑĞ½ÑÑŒĞºĞ¸Ğ¹ âœˆï¸"],
    "Ğ¥Ğ°Ñ€ĞºÑ–Ğ² ğŸ—ï¸": ["Ğ¡Ğ°Ğ»Ñ‚Ñ–Ğ²ĞºĞ° ğŸ¢", "Ğ¦ĞµĞ½Ñ‚Ñ€ ğŸ›ï¸", "Ğ¥Ğ¾Ğ»Ğ¾Ğ´Ğ½Ğ° Ğ“Ğ¾Ñ€Ğ° ğŸ”ï¸", "Ğ¡Ğ»Ğ¾Ğ±Ñ–Ğ´ÑÑŒĞºĞ¸Ğ¹ ğŸŸï¸", "Ğ†Ğ½Ğ´ÑƒÑÑ‚Ñ€Ñ–Ğ°Ğ»ÑŒĞ½Ğ¸Ğ¹ ğŸ­", "Ğ¥Ğ¢Ğ— ğŸ› ï¸", "ĞĞ»ĞµĞºÑÑ–Ñ—Ğ²ĞºĞ° ğŸ—ï¸", "ĞœĞ¾ÑĞºĞ¾Ğ²ÑÑŒĞºĞ¸Ğ¹ ğŸ¤"],
    "ĞĞ´ĞµÑĞ° âš“": ["ĞŸÑ€Ğ¸Ğ¼Ğ¾Ñ€ÑÑŒĞºĞ¸Ğ¹ ğŸŒŠ", "Ğ¡ÑƒĞ²Ğ¾Ñ€Ğ¾Ğ²ÑÑŒĞºĞ¸Ğ¹ ğŸšœ", "ĞœĞ°Ğ»Ğ¸Ğ½Ğ¾Ğ²ÑÑŒĞºĞ¸Ğ¹ ğŸ·", "ĞšĞ¸Ñ—Ğ²ÑÑŒĞºĞ¸Ğ¹ ğŸ–ï¸", "Ğ‘Ğ»Ğ¸Ğ¶Ğ½Ñ– ĞœĞ»Ğ¸Ğ½Ğ¸ ğŸ ", "Ğ”Ğ°Ğ»ÑŒĞ½Ñ– ĞœĞ»Ğ¸Ğ½Ğ¸ ğŸ˜ï¸", "Ğ¢Ğ°Ñ—Ñ€Ğ¾Ğ²Ğ¾ ğŸ¢", "Ğ¡Ğ»Ğ¾Ğ±Ñ–Ğ´ĞºĞ° ğŸ¥"],
    "Ğ”Ğ½Ñ–Ğ¿Ñ€Ğ¾ ğŸŒŠ": ["Ğ¦ĞµĞ½Ñ‚Ñ€ ğŸ™ï¸", "ĞŸĞµÑ€ĞµĞ¼Ğ¾Ğ³Ğ° ğŸ¡", "Ğ¢Ğ¾Ğ¿Ğ¾Ğ»Ñ ğŸŒ³", "Ğ›Ñ–Ğ²Ğ¾Ğ±ĞµÑ€ĞµĞ¶Ğ½Ğ¸Ğ¹-3 ğŸš‰", "Ğ§ĞµÑ‡ĞµĞ»Ñ–Ğ²ÑÑŒĞºĞ¸Ğ¹ ğŸ—ï¸", "Ğ¨ĞµĞ²Ñ‡ĞµĞ½ĞºÑ–Ğ²ÑÑŒĞºĞ¸Ğ¹ ğŸ¢", "ĞĞ¾Ğ²Ğ¾ĞºĞ¾Ğ´Ğ°Ñ†ÑŒĞºĞ¸Ğ¹ ğŸ­", "ĞĞ¼ÑƒÑ€-ĞĞ¸Ğ¶Ğ½ÑŒĞ¾Ğ´Ğ½Ñ–Ğ¿Ñ€Ğ¾Ğ²ÑÑŒĞºĞ¸Ğ¹ ğŸŒ‰"],
    "Ğ›ÑŒĞ²Ñ–Ğ² ğŸ¦": ["Ğ“Ğ°Ğ»Ğ¸Ñ†ÑŒĞºĞ¸Ğ¹ ğŸ°", "Ğ—Ğ°Ğ»Ñ–Ğ·Ğ½Ğ¸Ñ‡Ğ½Ğ¸Ğ¹ ğŸš‚", "Ğ¤Ñ€Ğ°Ğ½ĞºÑ–Ğ²ÑÑŒĞºĞ¸Ğ¹ ğŸ¨", "Ğ¨ĞµĞ²Ñ‡ĞµĞ½ĞºÑ–Ğ²ÑÑŒĞºĞ¸Ğ¹ ğŸŒ³", "Ğ¡Ğ¸Ñ…Ñ–Ğ²ÑÑŒĞºĞ¸Ğ¹ ğŸ¢", "Ğ›Ğ¸Ñ‡Ğ°ĞºÑ–Ğ²ÑÑŒĞºĞ¸Ğ¹ â›²", "Ğ“Ğ¾Ñ€Ñ–Ñ…Ñ–Ğ² ğŸ˜ï¸", "Ğ¡Ñ‚Ğ°Ñ€Ğ¸Ğ¹ Ğ›ÑŒĞ²Ñ–Ğ² ğŸ›ï¸"],
    "Ğ—Ğ°Ğ¿Ğ¾Ñ€Ñ–Ğ¶Ğ¶Ñ âš¡": ["Ğ”Ğ½Ñ–Ğ¿Ñ€Ğ¾Ğ²ÑÑŒĞºĞ¸Ğ¹ ğŸ”‹", "Ğ’Ğ¾Ğ·Ğ½ĞµÑĞµĞ½Ñ–Ğ²ÑÑŒĞºĞ¸Ğ¹ ğŸŒ³", "ĞĞ»ĞµĞºÑĞ°Ğ½Ğ´Ñ€Ñ–Ğ²ÑÑŒĞºĞ¸Ğ¹ ğŸ›ï¸", "ĞšĞ¾Ğ¼ÑƒĞ½Ğ°Ñ€ÑÑŒĞºĞ¸Ğ¹ ğŸ˜ï¸", "Ğ¥Ğ¾Ñ€Ñ‚Ğ¸Ñ†ÑŒĞºĞ¸Ğ¹ ğŸ", "Ğ¨ĞµĞ²Ñ‡ĞµĞ½ĞºÑ–Ğ²ÑÑŒĞºĞ¸Ğ¹ ğŸ¢", "Ğ—Ğ°Ğ²Ğ¾Ğ´ÑÑŒĞºĞ¸Ğ¹ ğŸ­", "ĞÑÑ‚Ñ€Ğ¾Ğ²Ğ¸ ğŸï¸"],
    "ĞšÑ€Ğ¸Ğ²Ğ¸Ğ¹ Ğ Ñ–Ğ³ ğŸ”©": ["Ğ¦ĞµĞ½Ñ‚Ñ€Ğ°Ğ»ÑŒĞ½Ğ¸Ğ¹ ğŸ™ï¸", "Ğ¢ĞµÑ€Ğ½Ñ–Ğ²ÑÑŒĞºĞ¸Ğ¹ â›ï¸", "ĞŸĞ¾ĞºÑ€Ğ¾Ğ²ÑÑŒĞºĞ¸Ğ¹ ğŸ›ï¸", "Ğ¡Ğ°ĞºÑĞ°Ğ³Ğ°Ğ½ÑÑŒĞºĞ¸Ğ¹ ğŸ¡", "Ğ”Ğ¾Ğ²Ğ³Ğ¸Ğ½Ñ†Ñ–Ğ²ÑÑŒĞºĞ¸Ğ¹ ğŸš‚", "ĞœĞµÑ‚Ğ°Ğ»ÑƒÑ€Ğ³Ñ–Ğ¹Ğ½Ğ¸Ğ¹ ğŸ­", "Ğ†Ğ½Ğ³ÑƒĞ»ĞµÑ†ÑŒĞºĞ¸Ğ¹ ğŸŒ³", "ĞŸÑ–Ğ²Ğ´ĞµĞ½Ğ½Ğ¸Ğ¹ ğŸ—ï¸"],
    "Ğ’Ñ–Ğ½Ğ½Ğ¸Ñ†Ñ â›²": ["Ğ—Ğ°Ğ¼Ğ¾ÑÑ‚Ñ ğŸ¢", "Ğ’Ğ¸ÑˆĞµĞ½ÑŒĞºĞ° ğŸ’", "ĞŸĞ¾Ğ´Ñ–Ğ» ğŸŒŠ", "Ğ¡Ñ‚Ğ°Ñ€Ğµ Ğ¼Ñ–ÑÑ‚Ğ¾ ğŸ›ï¸", "Ğ‘Ñ€Ğ¸Ğ³Ğ°Ğ½Ñ‚Ğ¸Ğ½Ğ° â›´ï¸", "ĞĞºĞ°Ğ´ĞµĞ¼Ñ–Ñ‡Ğ½Ğ¸Ğ¹ ğŸ“", "Ğ¢ÑĞ¶Ğ¸Ğ»Ñ–Ğ² ğŸ—ï¸", "Ğ¡Ğ»Ğ¾Ğ²â€™ÑĞ½ĞºĞ° ğŸ˜ï¸"],
    "ĞœĞ¸ĞºĞ¾Ğ»Ğ°Ñ—Ğ² ğŸš¢": ["Ğ¦ĞµĞ½Ñ‚Ñ€Ğ°Ğ»ÑŒĞ½Ğ¸Ğ¹ ğŸ™ï¸", "Ğ—Ğ°Ğ²Ğ¾Ğ´ÑÑŒĞºĞ¸Ğ¹ ğŸ—ï¸", "Ğ†Ğ½Ğ³ÑƒĞ»ÑŒÑÑŒĞºĞ¸Ğ¹ ğŸŒŠ", "ĞšĞ¾Ñ€Ğ°Ğ±ĞµĞ»ÑŒĞ½Ğ¸Ğ¹ âš“", "Ğ’Ğ°Ñ€Ğ²Ğ°Ñ€Ñ–Ğ²ĞºĞ° ğŸ˜ï¸", "Ğ¢ĞµÑ€Ğ½Ñ–Ğ²ĞºĞ° ğŸŒ³", "Ğ¡Ğ¾Ğ»ÑĞ½Ñ– ğŸ ", "ĞœĞ°Ñ‚Ğ²Ñ–Ñ—Ğ²ĞºĞ° ğŸŒ²"],
    "Ğ§ĞµÑ€Ğ½Ñ–Ğ³Ñ–Ğ² ğŸ°": ["Ğ”ĞµÑĞ½ÑĞ½ÑÑŒĞºĞ¸Ğ¹ ğŸŒ³", "ĞĞ¾Ğ²Ğ¾Ğ·Ğ°Ğ²Ğ¾Ğ´ÑÑŒĞºĞ¸Ğ¹ ğŸ›ï¸", "Ğ¦ĞµĞ½Ñ‚Ñ€ ğŸ¡", "Ğ›Ñ–ÑĞºĞ¾Ğ²Ğ¸Ñ†Ñ ğŸ˜ï¸", "Ğ¨ĞµÑ€ÑÑ‚ÑĞ½ĞºĞ° ğŸ­", "ĞœĞ°ÑĞ°Ğ½Ğ¸ ğŸ—ï¸", "Ğ‘Ğ¾Ğ±Ñ€Ğ¾Ğ²Ğ¸Ñ†Ñ ğŸ ", "ĞŸĞ¾Ğ´ÑƒÑÑ–Ğ²ĞºĞ° ğŸŒ²"],
    "ĞšĞ°Ğ¼'ÑĞ½ÑÑŒĞºĞµ ğŸ› ï¸": ["Ğ¦ĞµĞ½Ñ‚Ñ€Ğ°Ğ»ÑŒĞ½Ğ¸Ğ¹ ğŸ¤", "ĞŸÑ–Ğ²Ğ´ĞµĞ½Ğ½Ğ¸Ğ¹ ğŸ—ï¸", "Ğ”Ğ½Ñ–Ğ¿Ñ€Ğ¾Ğ²ÑÑŒĞºĞ¸Ğ¹ ğŸŒŠ", "ĞĞ¾Ğ²Ğ¾ĞºĞ°Ğ¼â€™ÑĞ½ĞºĞ° ğŸ ", "ĞŸĞ¾Ğ±ĞµĞ´Ğ° ğŸ¢", "ĞŸÑ€Ğ°Ğ²Ğ¾Ğ±ĞµÑ€ĞµĞ¶Ğ½Ğ¸Ğ¹ ğŸ˜ï¸", "Ğ›Ñ–Ğ²Ğ¾Ğ±ĞµÑ€ĞµĞ¶Ğ½Ğ¸Ğ¹ ğŸŒ³", "ĞœÑ–ÑÑ‚Ğ¾-Ñ†ĞµĞ½Ñ‚Ñ€ ğŸ™ï¸"]
}

VAPES = [
    {"id": 0, "name": "ğŸŠ Packwoods Orange", "old": 1149.0, "img": "https://i.ibb.co/V03f2yYF/Ghost-Vape-1.jpg"},
    {"id": 1, "name": "ğŸŒ¸ Packwoods Pink", "old": 1259.0, "img": "https://i.ibb.co/65j1901/Ghost-Vape-2.jpg"},
    {"id": 2, "name": "ğŸ‡ Packwoods Purple", "old": 1369.0, "img": "https://i.ibb.co/svXqXPgL/Ghost-Vape-3.jpg"},
    {"id": 3, "name": "â„ï¸ Whole Mint", "old": 1549.0, "img": "https://i.ibb.co/675LQrNB/Ghost-Vape-4.jpg"},
    {"id": 4, "name": "ğŸŒ´ Jungle Boys", "old": 1659.0, "img": "https://i.ibb.co/Zzk29HMy/Ghost-Vape-5.jpg"}
]

NEW_TERMS = (
    "ğŸ“œ *Ğ£Ğ¼Ğ¾Ğ²Ğ¸, Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ°, Ğ²Ñ–Ğ´Ğ¿Ğ¾Ğ²Ñ–Ğ´Ğ°Ğ»ÑŒĞ½Ñ–ÑÑ‚ÑŒ*\n\n"
    "1ï¸âƒ£ ĞŸÑ€Ğ¾Ñ”ĞºÑ‚ Ğ¼Ğ°Ñ” Ğ½Ğ°Ğ²Ñ‡Ğ°Ğ»ÑŒĞ½Ğ¾-Ğ´ĞµĞ¼Ğ¾Ğ½ÑÑ‚Ñ€Ğ°Ñ†Ñ–Ğ¹Ğ½Ğ¸Ğ¹ Ñ…Ğ°Ñ€Ğ°ĞºÑ‚ĞµÑ€.\n"
    "2ï¸âƒ£ Ğ†Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ñ–Ñ Ğ¿Ğ¾Ğ´Ğ°Ñ”Ñ‚ÑŒÑÑ Ğ²Ğ¸ĞºĞ»ÑÑ‡Ğ½Ğ¾ Ğ· Ğ¾Ğ·Ğ½Ğ°Ğ¹Ğ¾Ğ¼Ñ‡Ğ¾Ñ Ğ¼ĞµÑ‚Ğ¾Ñ.\n"
    "3ï¸âƒ£ ĞœĞ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ğ¸ Ğ½Ğµ Ñ” Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ñ–Ñ”Ñ Ğ´Ğ¾ Ğ¿Ñ€Ğ¸Ğ´Ğ±Ğ°Ğ½Ğ½Ñ Ñ‡Ğ¸ Ğ²Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ°Ğ½Ğ½Ñ.\n"
    "4ï¸âƒ£ ĞšĞ¾Ñ€Ğ¸ÑÑ‚ÑƒĞ²Ğ°Ñ‡ ÑĞ°Ğ¼Ğ¾ÑÑ‚Ñ–Ğ¹Ğ½Ğ¾ Ğ½ĞµÑĞµ Ğ²Ñ–Ğ´Ğ¿Ğ¾Ğ²Ñ–Ğ´Ğ°Ğ»ÑŒĞ½Ñ–ÑÑ‚ÑŒ Ğ·Ğ° ÑĞ²Ğ¾Ñ— Ğ´Ñ–Ñ—.\n"
    "5ï¸âƒ£ ĞĞ´Ğ¼Ñ–Ğ½Ñ–ÑÑ‚Ñ€Ğ°Ñ†Ñ–Ñ Ğ½Ğµ Ğ·Ğ±ĞµÑ€Ñ–Ğ³Ğ°Ñ” Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ»ÑŒĞ½Ñ– Ğ´Ğ°Ğ½Ñ–.\n"
    "6ï¸âƒ£ Ğ£Ñ‡Ğ°ÑÑ‚ÑŒ Ñƒ Ğ²Ğ·Ğ°Ñ”Ğ¼Ğ¾Ğ´Ñ–Ñ— Ñ” Ğ´Ğ¾Ğ±Ñ€Ğ¾Ğ²Ñ–Ğ»ÑŒĞ½Ğ¾Ñ.\n\n"
    "âš ï¸ *Ğ’Ğ°Ğ¶Ğ»Ğ¸Ğ²Ğ¾:*\n"
    "7ï¸âƒ£ ĞœĞ°Ğ³Ğ°Ğ·Ğ¸Ğ½ Ğ½Ğµ Ñ” Ñ€ĞµĞ°Ğ»ÑŒĞ½Ğ¸Ğ¼ Ñ‚Ğ° Ğ½Ğµ Ğ·Ğ´Ñ–Ğ¹ÑĞ½ÑÑ” Ğ¿Ñ€Ğ¾Ğ´Ğ°Ğ¶ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñ–Ğ².\n"
    "8ï¸âƒ£ Ğ–Ğ¾Ğ´ĞµĞ½ Ñ‚Ğ¾Ğ²Ğ°Ñ€ Ğ½Ğµ Ğ±ÑƒĞ´Ğµ Ğ´Ğ¾ÑÑ‚Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğ¹.\n"
    "9ï¸âƒ£ Ğ£ÑÑ– Ğ¿ĞµÑ€ĞµĞºĞ°Ğ·Ğ°Ğ½Ñ– ĞºĞ¾ÑˆÑ‚Ğ¸ Ğ²Ğ²Ğ°Ğ¶Ğ°ÑÑ‚ÑŒÑÑ Ğ´Ğ¾Ğ±Ñ€Ğ¾Ğ²Ñ–Ğ»ÑŒĞ½Ğ¸Ğ¼ Ğ¿Ğ¾Ğ´Ğ°Ñ€ÑƒĞ½ĞºĞ¾Ğ¼.\n"
    "ğŸ”Ÿ Ğ’ÑÑ– Ğ³Ñ€Ğ¾ÑˆĞ¾Ğ²Ñ– Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ñ–Ñ— Ñ‡ĞµÑ€ĞµĞ· Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ğ° â€” Ğ¿Ğ¾Ğ´Ğ°Ñ€ÑƒĞ½Ğ¾Ğº ĞºĞ¾Ğ´ĞµÑ€Ñƒ Ñ‚Ğ° Ñ€Ğ¾Ğ·Ñ€Ğ¾Ğ±Ğ½Ğ¸ĞºÑƒ Gho$$tyyy/"
)

# ================== UI HELPERS ==================

def get_main_kb():
    return InlineKeyboardMarkup([
        [InlineKeyboardButton("ğŸ‘¤ ĞœÑ–Ğ¹ ĞŸÑ€Ğ¾Ñ„Ñ–Ğ»ÑŒ ğŸ’³", callback_data="profile")],
        [InlineKeyboardButton("ğŸŒ¿ ĞĞĞ¡-Ğ’ĞµĞ¹Ğ¿Ğ¸ ğŸ’¨", callback_data="catalog")],
        [InlineKeyboardButton("ğŸ™ ĞĞ±Ñ€Ğ°Ñ‚Ğ¸ Ğ¼Ñ–ÑÑ‚Ğ¾ ğŸ“", callback_data="loc_cities")],
        [InlineKeyboardButton("ğŸ’» ĞœĞµĞ½ĞµĞ´Ğ¶ĞµÑ€ ğŸ‘¨â€ğŸ’»", url=MANAGER_URL)],
        [InlineKeyboardButton("ğŸ“œ ĞŸĞ¾Ğ»Ñ–Ñ‚Ğ¸ĞºĞ° âš–ï¸", callback_data="terms")]
    ])

# ================== CORE LOGIC ==================

async def send_welcome(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    if "reg_date" not in context.user_data:
        context.user_data["reg_date"] = datetime.now().strftime("%d.%m.%Y")
        context.user_data["promo"] = f"GHOST-{random.randint(100, 999)}PR"
    
    text = (
        f"ğŸŒ¿ *Ğ’Ñ–Ñ‚Ğ°Ñ”Ğ¼Ğ¾, {user.first_name}!* ğŸŒ¿\n\n"
        f"Ğ’Ğ°Ñˆ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ Ğ½Ğ° Ğ·Ğ½Ğ¸Ğ¶ĞºÑƒ *-30%*: `{context.user_data['promo']}`\n"
        f"ğŸ“… Ğ”Ñ–Ğ¹ÑĞ½Ğ¸Ğ¹ Ğ´Ğ¾: *{PROMO_EXPIRY}*\n\n"
        f"ĞĞ±ĞµÑ€Ñ–Ñ‚ÑŒ Ğ¿ÑƒĞ½ĞºÑ‚ Ğ¼ĞµĞ½Ñ Ğ½Ğ¸Ğ¶Ñ‡Ğµ: ğŸ‘‡"
    )
    
    if update.message:
        await update.message.reply_photo(WELCOME_PHOTO, caption=text, parse_mode="Markdown", reply_markup=get_main_kb())
    else:
        try:
            await update.callback_query.message.edit_media(
                InputMediaPhoto(WELCOME_PHOTO, caption=text, parse_mode="Markdown"),
                reply_markup=get_main_kb()
            )
        except: pass

async def dispatcher(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    data = query.data
    ud = context.user_data
    user = query.from_user
    await query.answer()

    async def render(txt, img=WELCOME_PHOTO, kb=None):
        try:
            await query.message.edit_media(InputMediaPhoto(img, caption=txt, parse_mode="Markdown"), reply_markup=kb)
        except:
            try: await query.message.edit_caption(caption=txt, parse_mode="Markdown", reply_markup=kb)
            except: pass

    # --- CATALOG LOGIC ---
    if data == "catalog":
        btns = []
        for v in VAPES:
            sale = round(v['old'] * DISCOUNT_RATE, 2)
            btns.append([InlineKeyboardButton(f"{v['name']} | {sale}â‚´ ğŸ”¥", callback_data=f"v_{v['id']}")])
        btns.append([InlineKeyboardButton("ğŸ  ĞĞ° Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ½Ñƒ", callback_data="start")])
        await render("ğŸ”¥ *ĞšĞ°Ñ‚Ğ°Ğ»Ğ¾Ğ³ Ğ²ĞµĞ¹Ğ¿Ñ–Ğ² (Ğ¦Ñ–Ğ½Ğ¸ Ğ·Ñ– Ğ·Ğ½Ğ¸Ğ¶ĞºĞ¾Ñ 30%):*", WELCOME_PHOTO, InlineKeyboardMarkup(btns))

    elif data.startswith("v_"):
        v = VAPES[int(data.split("_")[1])]
        sale = round(v['old'] * DISCOUNT_RATE, 2)
        loc = f"{ud.get('city','âŒ')}, {ud.get('dist','âŒ')}"
        caption = (
            f"*{v['name']}* ğŸŒ¿\n"
            f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
            f"âŒ Ğ¡Ñ‚Ğ°Ñ€Ğ° Ñ†Ñ–Ğ½Ğ°: ~{v['old']}~ Ğ³Ñ€Ğ½\n"
            f"âœ… *Ğ¦Ñ–Ğ½Ğ° Ğ·Ğ° Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ¼: {sale} Ğ³Ñ€Ğ½*\n"
            f"ğŸšš Ğ”Ğ¾ÑÑ‚Ğ°Ğ²ĞºĞ°: *Ğ‘ĞµĞ·ĞºĞ¾ÑˆÑ‚Ğ¾Ğ²Ğ½Ğ°*\n\n"
            f"ğŸ« ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ `{ud.get('promo')}` Ğ·Ğ°ÑÑ‚Ğ¾ÑĞ¾Ğ²Ğ°Ğ½Ğ¾!\n"
            f"ğŸ“ ĞŸĞ¾Ñ‚Ğ¾Ñ‡Ğ½Ğ° Ğ»Ğ¾ĞºĞ°Ñ†Ñ–Ñ: {loc}\n"
            f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
            f"Ğ—Ğ½Ğ¸Ğ¶ĞºĞ° Ğ´Ñ–Ñ” Ğ½Ğ° Ğ¿ĞµÑ€ÑˆĞµ Ğ·Ğ°Ğ¼Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ."
        )
        kb = InlineKeyboardMarkup([
            [InlineKeyboardButton("ğŸ› Ğ—Ğ°Ğ¼Ğ¾Ğ²Ğ¸Ñ‚Ğ¸ Ñƒ Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ğ°", url=MANAGER_URL)],
            [InlineKeyboardButton("ğŸ™ Ğ—Ğ¼Ñ–Ğ½Ğ¸Ñ‚Ğ¸ Ğ»Ğ¾ĞºĞ°Ñ†Ñ–Ñ", callback_data="loc_cities")],
            [InlineKeyboardButton("â¬…ï¸ ĞĞ°Ğ·Ğ°Ğ´ Ğ´Ğ¾ ÑĞ¿Ğ¸ÑĞºÑƒ", callback_data="catalog")]
        ])
        await render(caption, v['img'], kb)

    # --- LOCATION LOGIC ---
    elif data == "loc_cities":
        btns = []
        for c in LOCATIONS.keys():
            mark = "âœ… " if ud.get("city") == c else ""
            btns.append([InlineKeyboardButton(f"{mark}{c}", callback_data=f"sc_{c}")])
        btns.append([InlineKeyboardButton("ğŸ  ĞĞ° Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ½Ñƒ", callback_data="start")])
        await render("ğŸ™ *ĞĞ±ĞµÑ€Ñ–Ñ‚ÑŒ Ğ²Ğ°ÑˆĞµ Ğ¼Ñ–ÑÑ‚Ğ¾:*", WELCOME_PHOTO, InlineKeyboardMarkup(btns))

    elif data.startswith("sc_"):
        city = data.replace("sc_", "")
        ud["city"] = city
        btns = []
        for d in LOCATIONS[city]:
            mark = "âœ… " if ud.get("dist") == d else ""
            btns.append([InlineKeyboardButton(f"{mark}{d}", callback_data=f"sd_{d}")])
        btns.append([InlineKeyboardButton("â¬…ï¸ Ğ”Ğ¾ ÑĞ¿Ğ¸ÑĞºÑƒ Ğ¼Ñ–ÑÑ‚", callback_data="loc_cities")])
        await render(f"ğŸ˜ *{city}*. ĞĞ±ĞµÑ€Ñ–Ñ‚ÑŒ Ñ€Ğ°Ğ¹Ğ¾Ğ½:", WELCOME_PHOTO, InlineKeyboardMarkup(btns))

    elif data.startswith("sd_"):
        ud["dist"] = data.replace("sd_", "")
        await render(f"âœ… *Ğ›Ğ¾ĞºĞ°Ñ†Ñ–Ñ Ğ·Ğ±ĞµÑ€ĞµĞ¶ĞµĞ½Ğ¾!*\n\nğŸ“ {ud['city']}\nğŸ˜ {ud['dist']}", WELCOME_PHOTO, get_main_kb())

    # --- PROFILE LOGIC ---
    elif data == "profile":
        photos = await context.bot.get_user_profile_photos(user.id)
        p_img = photos.photos[0][-1].file_id if photos.total_count > 0 else WELCOME_PHOTO
        
        profile_text = (
            f"ğŸ‘¤ *ĞœĞ†Ğ™ ĞŸĞ ĞĞ¤Ğ†Ğ›Ğ¬* ğŸ’³\n"
            f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
            f"ğŸ“ *Ğ†Ğ¼'Ñ:* {user.first_name}\n"
            f"ğŸ“§ *Username:* @{user.username if user.username else 'Ğ½ĞµĞ¼Ğ°Ñ”'}\n"
            f"ğŸ†” *Ğ’Ğ°Ñˆ ID:* `{user.id}`\n"
            f"ğŸ“… *Ğ ĞµÑ”ÑÑ‚Ñ€Ğ°Ñ†Ñ–Ñ:* {ud.get('reg_date')}\n\n"
            f"ğŸ« *ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´:* `{ud.get('promo')}`\n"
            f"ğŸ”¥ *Ğ—Ğ½Ğ¸Ğ¶ĞºĞ°:* -30% Ğ½Ğ° 1-ÑˆĞµ Ğ·Ğ°Ğ¼Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ\n"
            f"â³ *Ğ¢ĞµÑ€Ğ¼Ñ–Ğ½ Ğ´Ñ–Ñ—:* Ğ´Ğ¾ {PROMO_EXPIRY}\n\n"
            f"ğŸ“ *ĞœÑ–ÑÑ‚Ğ¾:* {ud.get('city','âŒ ĞĞµ Ğ¾Ğ±Ñ€Ğ°Ğ½Ğ¾')}\n"
            f"ğŸ˜ *Ğ Ğ°Ğ¹Ğ¾Ğ½:* {ud.get('dist','âŒ ĞĞµ Ğ¾Ğ±Ñ€Ğ°Ğ½Ğ¾')}\n"
            f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
            f"ğŸ’¡ _ĞĞ°Ñ‚Ğ¸ÑĞ½Ñ–Ñ‚ÑŒ Ğ½Ğ° ID Ğ°Ğ±Ğ¾ ĞšĞ¾Ğ´ Ğ´Ğ»Ñ ĞºĞ¾Ğ¿Ñ–ÑĞ²Ğ°Ğ½Ğ½Ñ_"
        )
        kb = InlineKeyboardMarkup([
            [InlineKeyboardButton("ğŸ™ ĞĞ±Ñ€Ğ°Ñ‚Ğ¸ Ğ¼Ñ–ÑÑ‚Ğ¾/Ñ€Ğ°Ğ¹Ğ¾Ğ½", callback_data="loc_cities")],
            [InlineKeyboardButton("ğŸ  ĞĞ° Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ½Ñƒ", callback_data="start")]
        ])
        await render(profile_text, p_img, kb)

    # --- TERMS & HOME ---
    elif data == "terms":
        await render(NEW_TERMS, WELCOME_PHOTO, InlineKeyboardMarkup([[InlineKeyboardButton("ğŸ  ĞĞ° Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ½Ñƒ", callback_data="start")]]))
    
    elif data == "start":
        await send_welcome(update, context)

# ================== PRODUCTION LAUNCH ==================
def main():
    # Build application with modern settings
    app = ApplicationBuilder().token(TOKEN).build()
    
    app.add_handler(CommandHandler("start", send_welcome))
    app.add_handler(CallbackQueryHandler(dispatcher))
    
    print("ğŸš€ System Online | Ghossty Master Engine")
    app.run_polling(drop_pending_updates=True)

if __name__ == "__main__":
    main()
